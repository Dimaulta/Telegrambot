name: Deploy to Production (Smart Rebuild)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # –ù—É–∂–Ω–æ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∫–æ–º–º–∏—Ç–æ–º
      
      - name: Detect changed services
        id: changed
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –ø–∞–ø–∫–∏/—Å–µ—Ä–≤–∏—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # –ù–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏)
          NON_WORKING_SERVICES="veonowbot|banananowbot|soranowbot|golosnowbot|AntispamNowBot|NeurVideoBot"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏–ª–∏ —Ç–æ–ª—å–∫–æ services.json
          ONLY_NON_WORKING=$(echo "$CHANGED_FILES" | grep -vE "^($NON_WORKING_SERVICES)/|^config/services.json$|^docs/|^\.github/|^README|^SECURITY|^TRANSFER|^check_ssl|^config/nginx|^config/traefik" || true)
          
          if [ -z "$ONLY_NON_WORKING" ]; then
            # –ò–∑–º–µ–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏–ª–∏ —Ç–æ–ª—å–∫–æ services.json/docs - –Ω–µ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º
            SERVICES="none"
          else
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–∏–µ —Ñ–∞–π–ª—ã
            if echo "$CHANGED_FILES" | grep -qE "docker-compose.prod.yml|Dockerfile.prod"; then
              SERVICES="all"
            elif echo "$CHANGED_FILES" | grep -qE "^Package.resolved$"; then
              # Package.resolved –∏–∑–º–µ–Ω–∏–ª—Å—è - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å, –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –≤—Å—ë
              SERVICES="all"
            elif echo "$CHANGED_FILES" | grep -qE "^Package.swift$"; then
              # Package.swift –∏–∑–º–µ–Ω–∏–ª—Å—è - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —á—Ç–æ –∏–º–µ–Ω–Ω–æ
              PACKAGE_DIFF=$(git diff HEAD~1 HEAD -- Package.swift)
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –æ–±—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–≤–µ—Ä—Å–∏–∏ –ø–∞–∫–µ—Ç–æ–≤ –≤ —Å–µ–∫—Ü–∏–∏ dependencies)
              if echo "$PACKAGE_DIFF" | grep -qE "^\+.*\.package\(|^\-.*\.package\(|from:|\.upToNextMajor|\.upToNextMinor"; then
                # –û–±—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å - –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –≤—Å—ë
                SERVICES="all"
              else
                # –ò–∑–º–µ–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ —Ç–∞—Ä–≥–µ—Ç—ã –∏–ª–∏ –∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ
                CHANGED_TARGETS=""
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ç–∞—Ä–≥–µ—Ç—ã
                NON_WORKING_TARGETS="GolosNowBot|NeurVideoBot|AntispamNowBot|VeoNowBot|SoranowBot|BananaNowBot"
                ONLY_NON_WORKING_TARGETS=true
                
                # –ú–∞–ø–ø–∏–Ω–≥ —Ç–∞—Ä–≥–µ—Ç–æ–≤ Package.swift –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã docker-compose
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"NowControllerBot\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS nowcontrollerbot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"VideoServiceRunner\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS roundsvideobot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"NowmttBot\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS nowmttbot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"GSForTextBot\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS gsfortextbot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"ContentFabrikaBot\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS contentfabrikabot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"Neurfotobot\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS neurfotobot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"PereskazNowBot\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS pereskaznowbot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                
                # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ç–∞—Ä–≥–µ—Ç—ã - –Ω–µ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –Ω–∏—á–µ–≥–æ
                if [ "$ONLY_NON_WORKING_TARGETS" = true ]; then
                  SERVICES="none"
                elif [ -n "$CHANGED_TARGETS" ]; then
                  # –ò–∑–º–µ–Ω–∏–ª–∏—Å—å —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Ç–∞—Ä–≥–µ—Ç—ã - –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –∏—Ö
                  SERVICES="$CHANGED_TARGETS"
                else
                  # –ù–µ —Å–º–æ–≥–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å - –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≤—Å—ë –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                  SERVICES="all"
                fi
              fi
            else
              # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã
              SERVICES=""
              if echo "$CHANGED_FILES" | grep -qE "^Neurfotobot/|^neurfotobot/"; then
                SERVICES="$SERVICES neurfotobot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^Roundsvideobot/|^roundsvideobot/"; then
                SERVICES="$SERVICES roundsvideobot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^nowmttbot/"; then
                SERVICES="$SERVICES nowmttbot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^gsfortextbot/"; then
                SERVICES="$SERVICES gsfortextbot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^contentfabrikabot/"; then
                SERVICES="$SERVICES contentfabrikabot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^pereskaznowbot/"; then
                SERVICES="$SERVICES pereskaznowbot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^nowcontrollerbot/"; then
                SERVICES="$SERVICES nowcontrollerbot"
              fi
              
              # –ï—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã - –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≤—Å—ë –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
              if [ -z "$SERVICES" ]; then
                SERVICES="all"
              fi
            fi
          fi
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "üîç –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã: $SERVICES"
      
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_SSH_PORT }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /root/Telegrambot
            echo "üì• –ü–æ–ª—É—á–∞—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ main..."
            git fetch origin
            git checkout main
            git pull origin main
            
            CHANGED_SERVICES="${{ steps.changed.outputs.services }}"
            
            if [ "$CHANGED_SERVICES" = "none" ]; then
              echo "‚ÑπÔ∏è –ò–∑–º–µ–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã/services.json/–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è - –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
            elif [ "$CHANGED_SERVICES" = "all" ]; then
              echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
              docker compose -f docker-compose.prod.yml build
              docker compose -f docker-compose.prod.yml up -d
            else
              echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã: $CHANGED_SERVICES"
              for service in $CHANGED_SERVICES; do
                echo "  ‚Üí –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é $service..."
                docker compose -f docker-compose.prod.yml build $service
                docker compose -f docker-compose.prod.yml up -d $service
              done
            fi
            
            echo "‚è≥ –ñ–¥—É –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (30 —Å–µ–∫—É–Ω–¥)..."
            sleep 30
            
            echo "üîó –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é webhooks..."
            set -a; source config/.env; set +a
            ./config/set-webhooks.sh
            
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose -f docker-compose.prod.yml ps
            
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"

