# ContentFabrikaBot - Краткое описание для документации

## Что это за сервис

ContentFabrikaBot — это Telegram бот, который помогает авторам Telegram каналов создавать посты в их уникальном стиле. Бот использует OpenAI API для анализа стиля написания автора и генерации новых постов по заданной теме.

## Как работает сервис

1. **Автор добавляет бота в свой канал** как администратора с правом публикации
2. **Бот автоматически сохраняет новые посты** из канала в базу данных SQLite (когда получает их через webhook)
3. **Автор нажимает "Изучить канал"** → бот анализирует последние 10 постов через OpenAI и создает профиль стиля
4. **Автор отправляет тему** для нового поста → бот генерирует пост в стиле автора через OpenAI
5. **При изменении стиля** автор может использовать команду `/relearn` для переобучения на основе новых постов

## Технические детали

- **Платформа**: Swift + Vapor framework
- **База данных**: SQLite (файл `contentfabrikabot/db.sqlite`)
- **Порт**: 8089 (настраивается в `config/services.json`)
- **Webhook URL**: `${BASE_URL}/contentfabrika/webhook`
- **Модель OpenAI**: `gpt-4o-mini`

## Команды для запуска

### 1. Установка зависимостей (если нужно)
```bash
swift package resolve
```

### 2. Запуск бота
```bash
swift run ContentFabrikaBot
```

Бот будет слушать на порту 8089.

### 3. Настройка webhook (после запуска сервера)
```bash
# Полная версия с проверками
bash config/set-webhooks.sh

# Или быстрая версия
bash config/set-webhooks-manual.sh
```

## Необходимые API ключи

### 1. Telegram Bot Token
- **Где получить**: [@BotFather](https://t.me/BotFather) в Telegram
- **Команда**: `/newbot`
- **Переменная окружения**: `CONTENTFABRIKABOT_TOKEN`
- **Формат**: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`

### 2. OpenAI API Key
- **Где получить**: [platform.openai.com](https://platform.openai.com/)
- **Путь**: API Keys → Create new secret key
- **Важно**: Выбрать опцию "You" (личный ключ), не "Service account"
- **Переменная окружения**: `OPENAI_API_KEY`
- **Формат**: `sk-...`
- **Модель**: Используется `gpt-4o-mini` (дешевле чем gpt-4)

## Настройка переменных окружения

1. Скопировать `config/env.example` в `config/.env`
2. Заполнить переменные:
```bash
CONTENTFABRIKABOT_TOKEN=твой_токен_от_BotFather
OPENAI_API_KEY=твой_ключ_от_OpenAI
BASE_URL=https://твой_домен_или_ngrok_url
```

## Структура базы данных

- **channels** — информация о каналах (ID канала, владелец, название)
- **style_profiles** — профили стиля авторов (описание стиля, количество проанализированных постов)
- **channel_posts** — сохраненные посты из каналов (текст, дата, message_id)

## Основные команды бота

- `/start` — начать работу, показать меню
- `/relearn` — переизучить стиль канала на основе новых постов

## Особенности

- Telegram Bot API не позволяет получать историю сообщений канала напрямую
- Бот сохраняет только те посты, которые получил после того, как стал админом канала
- Для изучения старых постов автор может переслать их боту вручную
- Бот автоматически ограничивает количество сохраненных постов (максимум 50 последних)

## Файлы конфигурации

- `config/services.json` — конфигурация сервиса (порт, маршруты)
- `config/.env` — секретные ключи (не коммитится в git)
- `contentfabrikabot/db.sqlite` — база данных (создается автоматически)

