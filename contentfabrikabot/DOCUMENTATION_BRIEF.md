# ContentFabrikaBot - Краткое описание для документации

## Что это за сервис

ContentFabrikaBot — это Telegram бот, который помогает авторам Telegram каналов создавать посты в их уникальном стиле. Бот использует OpenAI API для анализа стиля написания автора и генерации новых постов по заданной теме.

## Как работает сервис

1. Автор запускает бота и пересылает (Forward) 5–10 постов из своего канала.
2. После накопления минимум 3 публикаций активируется кнопка «Изучить канал» — бот анализирует стиль через OpenAI.
3. Пользователь отправляет тему или промт — бот генерирует текст в изученном стиле и отправляет его в чат.
4. Автор вручную копирует текст и публикует у себя в канале.
5. Команда `/relearn` переизучает стиль на основе новых пересланных постов.
6. Один пользователь может вести несколько каналов, выбирая нужный через inline-кнопки.

## Технические детали

- **Платформа**: Swift + Vapor framework
- **База данных**: SQLite (файл `contentfabrikabot/db.sqlite`)
- **Порт**: 8089 (настраивается в `config/services.json`)
- **Webhook URL**: `${BASE_URL}/contentfabrika/webhook`
- **Модель OpenAI**: `gpt-4o-mini`
- **Обработка webhook'ов**: `message`, `callback_query`
- **Результат генерации**: всегда текстовый ответ в чат пользователя
- **Логирование**: LoggingMiddleware для диагностики запросов

## Команды для запуска

### 1. Установка зависимостей (если нужно)
```bash
swift package resolve
```

### 2. Запуск бота
```bash
swift run ContentFabrikaBot
```

Бот будет слушать на порту 8089.

### 3. Настройка webhook (после запуска сервера)
```bash
bash config/set-webhooks.sh
```

## Необходимые API ключи

### 1. Telegram Bot Token
- **Где получить**: [@BotFather](https://t.me/BotFather) в Telegram
- **Команда**: `/newbot`
- **Переменная окружения**: `CONTENTFABRIKABOT_TOKEN`
- **Формат**: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`

### 2. OpenAI API Key
- **Где получить**: [platform.openai.com](https://platform.openai.com/)
- **Путь**: API Keys → Create new secret key
- **Важно**: Выбрать опцию "You" (личный ключ), не "Service account"
- **Переменная окружения**: `OPENAI_API_KEY`
- **Формат**: `sk-...`
- **Модель**: Используется `gpt-4o-mini` (дешевле чем gpt-4)

## Настройка переменных окружения

1. Скопировать `config/env.example` в `config/.env`
2. Заполнить переменные:
```bash
CONTENTFABRIKABOT_TOKEN=твой_токен_от_BotFather
OPENAI_API_KEY=твой_ключ_от_OpenAI
BASE_URL=https://твой_домен_или_ngrok_url
```

## Структура базы данных

- **channels** — информация о каналах (ID канала, владелец, название)
- **style_profiles** — профили стиля авторов (описание стиля, количество проанализированных постов)
- **channel_posts** — сохраненные посты из каналов (текст, дата, message_id)

## Основные команды бота

- `/start` — начать работу, показать меню
- `/relearn` — переизучить стиль канала на основе новых постов
- `/reset` — удалить все данные (каналы, посты, профили стиля)

## Особенности

- Telegram Bot API не даёт доступа к истории канала, поэтому авторы пересылают нужные посты вручную.
- Храним до 50 последних пересланных публикаций на канал.
- Поддерживаются несколько каналов и inline-кнопки для выбора.
- KeyboardService отвечает за единообразные клавиатуры.

## Файлы конфигурации

- `config/services.json` — конфигурация сервиса (порт, маршруты)
- `config/.env` — секретные ключи (не коммитится в git)
- `contentfabrikabot/db.sqlite` — база данных (создается автоматически)

