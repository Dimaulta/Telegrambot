# Стабильный CI/CD: сборка в GitHub Actions (без нагрузки на VPS), деплой на VPS только pull.
# Подводные камни учтены: проверка ресурсов VPS, retry, обновление .last_deploy_commit только при успехе.

name: Deploy to Production (Build in GHA)

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changed.outputs.services }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key
          ssh-keyscan -p ${{ secrets.VPS_SSH_PORT }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Detect changed services
        id: changed
        run: |
          LAST_DEPLOY_COMMIT=$(ssh -i ~/.ssh/vps_key -p ${{ secrets.VPS_SSH_PORT }} -o StrictHostKeyChecking=no -o ConnectTimeout=15 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "cat /root/Telegrambot/.last_deploy_commit 2>/dev/null || echo 'none'" || echo "none")
          if [ -z "$LAST_DEPLOY_COMMIT" ] || [ "$LAST_DEPLOY_COMMIT" = "none" ]; then
            echo "Using HEAD~15 (no .last_deploy_commit or SSH failed)"
            LAST_DEPLOY_COMMIT="HEAD~15"
          elif ! git rev-parse --verify "$LAST_DEPLOY_COMMIT" >/dev/null 2>&1; then
            echo "Commit $LAST_DEPLOY_COMMIT not in repo, using HEAD~15"
            LAST_DEPLOY_COMMIT="HEAD~15"
          fi
          CHANGED_FILES=$(git diff --name-only "$LAST_DEPLOY_COMMIT" HEAD || true)
          echo "Changed files (excerpt):"
          echo "$CHANGED_FILES" | head -30

          IGNORE_PATTERN="^(${NON_WORKING:-veonowbot|banananowbot|soranowbot|AntispamNowBot|NeurVideoBot})/|^config/services.json$|^docs/|/docs/|^\\.github/|^README|/README\\.md$|^LICENSE$|^SECURITY|^TRANSFER|^check_ssl|^config/nginx|^config/traefik|^config/.*\\.sh$|\\.code-workspace$|^NEURFOTOBOT_NOTES_TMP|^SECURITY_AUDIT_REPORT|^\\.gitignore$|^\\.cursorignore$"
          LEFT=$(echo "$CHANGED_FILES" | grep -vE "$IGNORE_PATTERN" || true)
          if [ -z "$LEFT" ]; then
            echo "services=none" >> $GITHUB_OUTPUT
            echo "No rebuild needed (only ignored paths changed)"
            exit 0
          fi

          if echo "$CHANGED_FILES" | grep -qE "docker-compose.prod.yml|Dockerfile.prod"; then
            echo "services=nowcontrollerbot roundsvideobot filenowbot golosnowbot contentfabrikabot neurfotobot pereskaznowbot" >> $GITHUB_OUTPUT
            echo "Rebuild all (Dockerfile/compose changed)"
            exit 0
          fi
          if echo "$CHANGED_FILES" | grep -qE "^Package.resolved$"; then
            echo "services=nowcontrollerbot roundsvideobot filenowbot golosnowbot contentfabrikabot neurfotobot pereskaznowbot" >> $GITHUB_OUTPUT
            echo "Rebuild all (Package.resolved changed)"
            exit 0
          fi

          SERVICES=""
          echo "$CHANGED_FILES" | grep -qE "^nowcontrollerbot/" && SERVICES="$SERVICES nowcontrollerbot"
          echo "$CHANGED_FILES" | grep -qE "^Roundsvideobot/|^roundsvideobot/" && SERVICES="$SERVICES roundsvideobot"
          echo "$CHANGED_FILES" | grep -qE "^filenowbot/" && SERVICES="$SERVICES filenowbot"
          echo "$CHANGED_FILES" | grep -qE "^golosnowbot/" && SERVICES="$SERVICES golosnowbot"
          echo "$CHANGED_FILES" | grep -qE "^contentfabrikabot/" && SERVICES="$SERVICES contentfabrikabot"
          echo "$CHANGED_FILES" | grep -qE "^Neurfotobot/|^neurfotobot/" && SERVICES="$SERVICES neurfotobot"
          echo "$CHANGED_FILES" | grep -qE "^pereskaznowbot/" && SERVICES="$SERVICES pereskaznowbot"

          if [ -z "$SERVICES" ]; then
            if echo "$CHANGED_FILES" | grep -qE "^Package.swift$"; then
              PACKAGE_DIFF=$(git diff "$LAST_DEPLOY_COMMIT" HEAD -- Package.swift 2>/dev/null || true)
              echo "$PACKAGE_DIFF" | grep -qE "name: \"NowControllerBot\"" && SERVICES="$SERVICES nowcontrollerbot"
              echo "$PACKAGE_DIFF" | grep -qE "name: \"VideoServiceRunner\"" && SERVICES="$SERVICES roundsvideobot"
              echo "$PACKAGE_DIFF" | grep -qE "name: \"FileNowBot\"" && SERVICES="$SERVICES filenowbot"
              echo "$PACKAGE_DIFF" | grep -qE "name: \"GolosNowBot\"" && SERVICES="$SERVICES golosnowbot"
              echo "$PACKAGE_DIFF" | grep -qE "name: \"ContentFabrikaBot\"" && SERVICES="$SERVICES contentfabrikabot"
              echo "$PACKAGE_DIFF" | grep -qE "name: \"Neurfotobot\"" && SERVICES="$SERVICES neurfotobot"
              echo "$PACKAGE_DIFF" | grep -qE "name: \"PereskazNowBot\"" && SERVICES="$SERVICES pereskaznowbot"
            fi
          fi
          if [ -z "$SERVICES" ]; then
            echo "services=nowcontrollerbot roundsvideobot filenowbot golosnowbot contentfabrikabot neurfotobot pereskaznowbot" >> $GITHUB_OUTPUT
            echo "Rebuild all (could not map changed files to services)"
          else
            echo "services=$SERVICES" >> $GITHUB_OUTPUT
            echo "Rebuild:$SERVICES"
          fi

  build:
    needs: detect
    if: needs.detect.outputs.services != 'none'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build and push (sequential, only changed services)
        run: |
          CHANGED="${{ needs.detect.outputs.services }}"
          build_one() {
            local svc=$1 product=$2 port=$3
            if echo "$CHANGED" | grep -qw "$svc"; then
              echo "Building $svc ($product :$port)..."
              docker buildx build --platform linux/amd64 \
                -f Dockerfile.prod \
                --build-arg PRODUCT="$product" \
                --build-arg PORT="$port" \
                -t ${{ env.REGISTRY }}/${{ github.repository_owner }}/telegrambot-$svc:latest \
                --push .
            else
              echo "Skip $svc (not in changed list)"
            fi
          }
          build_one nowcontrollerbot NowControllerBot 8084
          build_one roundsvideobot VideoServiceRunner 8081
          build_one filenowbot FileNowBot 8085
          build_one golosnowbot GolosNowBot 8083
          build_one contentfabrikabot ContentFabrikaBot 8089
          build_one neurfotobot Neurfotobot 8082
          build_one pereskaznowbot PereskazNowBot 8090

  deploy:
    needs: [detect, build]
    if: needs.detect.result == 'success' && needs.build.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key
          ssh-keyscan -p ${{ secrets.VPS_SSH_PORT }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to VPS (pull and up)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_SSH_PORT }}
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 600s
          envs: GHCR_TOKEN
          script: |
            set -e
            cd /root/Telegrambot

            echo "Check VPS resources..."
            df -h / | tail -1
            free -h | head -2

            echo "Pull code..."
            git fetch origin
            git checkout main
            git reset --hard origin/main
            NEW_COMMIT=$(git rev-parse HEAD)
            echo "Commit: $NEW_COMMIT"

            echo "Login to GHCR..."
            echo "$GHCR_TOKEN" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin

            echo "Pull images and up..."
            docker compose -f docker-compose.prod.yml pull --quiet
            docker compose -f docker-compose.prod.yml up -d

            echo "Wait for services..."
            sleep 30

            echo "Webhooks..."
            set -a; [ -f config/.env ] && source config/.env; set +a
            [ -x ./config/set-webhooks.sh ] && ./config/set-webhooks.sh || true

            echo "$NEW_COMMIT" > /root/Telegrambot/.last_deploy_commit
            echo "Saved .last_deploy_commit"

            docker compose -f docker-compose.prod.yml ps
            echo "Deploy done."
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GHCR_USER: ${{ secrets.GHCR_USER }}

  deploy-no-rebuild:
    needs: detect
    if: needs.detect.outputs.services == 'none'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key
          ssh-keyscan -p ${{ secrets.VPS_SSH_PORT }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Sync code only (no rebuild)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_SSH_PORT }}
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 120s
          script: |
            cd /root/Telegrambot
            git fetch origin && git checkout main && git reset --hard origin/main
            COMMIT=$(git rev-parse HEAD)
            echo "$COMMIT" > /root/Telegrambot/.last_deploy_commit
            echo "Synced to $COMMIT, no rebuild."
