name: Deploy to Production (Smart Rebuild)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–±–æ—Ä–æ–∫
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 50  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º –¥–µ–ø–ª–æ–µ–º
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key
          ssh-keyscan -p ${{ secrets.VPS_SSH_PORT }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Detect changed services
        id: changed
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–º–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–ø–ª–æ—è —Å VPS —á–µ—Ä–µ–∑ SSH
          LAST_DEPLOY_COMMIT=$(ssh -i ~/.ssh/vps_key -p ${{ secrets.VPS_SSH_PORT }} -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "cat /root/Telegrambot/.last_deploy_commit 2>/dev/null || echo 'none'")
          
          # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –∏–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º HEAD~10 –∫–∞–∫ fallback
          if [ -z "$LAST_DEPLOY_COMMIT" ] || [ "$LAST_DEPLOY_COMMIT" = "none" ]; then
            echo "‚ö†Ô∏è –§–∞–π–ª .last_deploy_commit –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é HEAD~10 –∫–∞–∫ fallback"
            LAST_DEPLOY_COMMIT="HEAD~10"
          else
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–º–∏—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
            if ! git rev-parse --verify "$LAST_DEPLOY_COMMIT" >/dev/null 2>&1; then
              echo "‚ö†Ô∏è –ö–æ–º–º–∏—Ç $LAST_DEPLOY_COMMIT –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –∏—Å–ø–æ–ª—å–∑—É—é HEAD~10"
              LAST_DEPLOY_COMMIT="HEAD~10"
            else
              echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é –∫–æ–º–º–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–ø–ª–æ—è: $LAST_DEPLOY_COMMIT"
            fi
          fi
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –ø–∞–ø–∫–∏/—Å–µ—Ä–≤–∏—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–ø–ª–æ—è
          CHANGED_FILES=$(git diff --name-only "$LAST_DEPLOY_COMMIT" HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # –ù–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏)
          NON_WORKING_SERVICES="veonowbot|banananowbot|soranowbot|AntispamNowBot|NeurVideoBot"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏–ª–∏ —Ç–æ–ª—å–∫–æ services.json
          # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ CI/CD, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, –∫–æ–Ω—Ñ–∏–≥–∞—Ö –∏ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
          ONLY_NON_WORKING=$(echo "$CHANGED_FILES" | grep -vE "^($NON_WORKING_SERVICES)/|^config/services.json$|^docs/|/docs/|^\.github/|^README|/README\.md$|^LICENSE$|^SECURITY|^TRANSFER|^check_ssl|^config/nginx|^config/traefik|^config/.*\.sh$|\.code-workspace$|^NEURFOTOBOT_NOTES_TMP|^SECURITY_AUDIT_REPORT|^\.gitignore$|^\.cursorignore$" || true)
          
          if [ -z "$ONLY_NON_WORKING" ]; then
            # –ò–∑–º–µ–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏–ª–∏ —Ç–æ–ª—å–∫–æ services.json/docs - –Ω–µ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º
            SERVICES="none"
          else
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–∏–µ —Ñ–∞–π–ª—ã
            if echo "$CHANGED_FILES" | grep -qE "docker-compose.prod.yml|Dockerfile.prod"; then
              SERVICES="all"
            elif echo "$CHANGED_FILES" | grep -qE "^Package.resolved$"; then
              # Package.resolved –∏–∑–º–µ–Ω–∏–ª—Å—è - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å, –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –≤—Å—ë
              SERVICES="all"
            elif echo "$CHANGED_FILES" | grep -qE "^Package.swift$"; then
              # Package.swift –∏–∑–º–µ–Ω–∏–ª—Å—è - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —á—Ç–æ –∏–º–µ–Ω–Ω–æ
              PACKAGE_DIFF=$(git diff "$LAST_DEPLOY_COMMIT" HEAD -- Package.swift)
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –æ–±—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–≤–µ—Ä—Å–∏–∏ –ø–∞–∫–µ—Ç–æ–≤ –≤ —Å–µ–∫—Ü–∏–∏ dependencies)
              if echo "$PACKAGE_DIFF" | grep -qE "^\+.*\.package\(|^\-.*\.package\(|from:|\.upToNextMajor|\.upToNextMinor"; then
                # –û–±—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å - –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –≤—Å—ë
                SERVICES="all"
              else
                # –ò–∑–º–µ–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ —Ç–∞—Ä–≥–µ—Ç—ã –∏–ª–∏ –∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ
                CHANGED_TARGETS=""
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ç–∞—Ä–≥–µ—Ç—ã
                NON_WORKING_TARGETS="NeurVideoBot|AntispamNowBot|VeoNowBot|SoranowBot|BananaNowBot"
                ONLY_NON_WORKING_TARGETS=true
                
                # –ú–∞–ø–ø–∏–Ω–≥ —Ç–∞—Ä–≥–µ—Ç–æ–≤ Package.swift –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã docker-compose
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"NowControllerBot\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS nowcontrollerbot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"VideoServiceRunner\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS roundsvideobot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"NowmttBot\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS nowmttbot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"FileNowBot\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS filenowbot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"GolosNowBot\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS golosnowbot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"ContentFabrikaBot\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS contentfabrikabot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"Neurfotobot\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS neurfotobot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                if echo "$PACKAGE_DIFF" | grep -qE "name: \"PereskazNowBot\""; then
                  CHANGED_TARGETS="$CHANGED_TARGETS pereskaznowbot"
                  ONLY_NON_WORKING_TARGETS=false
                fi
                
                # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ç–∞—Ä–≥–µ—Ç—ã - –Ω–µ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –Ω–∏—á–µ–≥–æ
                if [ "$ONLY_NON_WORKING_TARGETS" = true ]; then
                  SERVICES="none"
                elif [ -n "$CHANGED_TARGETS" ]; then
                  # –ò–∑–º–µ–Ω–∏–ª–∏—Å—å —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Ç–∞—Ä–≥–µ—Ç—ã - –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –∏—Ö
                  SERVICES="$CHANGED_TARGETS"
                else
                  # –ù–µ —Å–º–æ–≥–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å - –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≤—Å—ë –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                  SERVICES="all"
                fi
              fi
            else
              # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã
              SERVICES=""
              if echo "$CHANGED_FILES" | grep -qE "^Neurfotobot/|^neurfotobot/"; then
                SERVICES="$SERVICES neurfotobot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^Roundsvideobot/|^roundsvideobot/"; then
                SERVICES="$SERVICES roundsvideobot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^filenowbot/"; then
                SERVICES="$SERVICES filenowbot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^golosnowbot/"; then
                SERVICES="$SERVICES golosnowbot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^contentfabrikabot/"; then
                SERVICES="$SERVICES contentfabrikabot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^pereskaznowbot/"; then
                SERVICES="$SERVICES pereskaznowbot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^nowcontrollerbot/"; then
                SERVICES="$SERVICES nowcontrollerbot"
              fi
              
              # –ï—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã - –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≤—Å—ë –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
              if [ -z "$SERVICES" ]; then
                SERVICES="all"
              fi
            fi
          fi
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "üîç –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã: $SERVICES"
      
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_SSH_PORT }}
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 5400s  # 90 –º–∏–Ω—É—Ç –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–±–æ—Ä–æ–∫
          script: |
            cd /root/Telegrambot
            echo "üì• –ü–æ–ª—É—á–∞—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ main..."
            git fetch origin
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            OLD_COMMIT=$(git rev-parse HEAD)
            echo "üìå –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º: $OLD_COMMIT"
            
            # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ main –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            git checkout main
            git reset --hard origin/main
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏–ª—Å—è
            NEW_COMMIT=$(git rev-parse HEAD)
            echo "üìå –ù–æ–≤—ã–π –∫–æ–º–º–∏—Ç –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: $NEW_COMMIT"
            
            if [ "$OLD_COMMIT" = "$NEW_COMMIT" ]; then
              echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –∫–æ–¥ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
            else
              echo "‚úÖ –ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω: $OLD_COMMIT -> $NEW_COMMIT"
            fi
            
            CHANGED_SERVICES="${{ steps.changed.outputs.services }}"
            
            if [ "$CHANGED_SERVICES" = "none" ]; then
              echo "‚ÑπÔ∏è –ò–∑–º–µ–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã/services.json/–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è - –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
            elif [ "$CHANGED_SERVICES" = "all" ]; then
              echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
              docker compose -f docker-compose.prod.yml build --progress=plain
              docker compose -f docker-compose.prod.yml up -d
            else
              echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã: $CHANGED_SERVICES"
              for service in $CHANGED_SERVICES; do
                echo "  ‚Üí –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é $service..."
                docker compose -f docker-compose.prod.yml build --progress=plain $service
                if [ $? -eq 0 ]; then
                  echo "  ‚úÖ $service —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ"
                  docker compose -f docker-compose.prod.yml up -d $service
                else
                  echo "  ‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ $service"
                  exit 1
                fi
              done
            fi
            
            echo "‚è≥ –ñ–¥—É –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (30 —Å–µ–∫—É–Ω–¥)..."
            sleep 30
            
            echo "üîó –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é webhooks..."
            set -a; source config/.env; set +a
            ./config/set-webhooks.sh
            
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose -f docker-compose.prod.yml ps
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–º–∏—Ç —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–ø–ª–æ—è –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞
            CURRENT_COMMIT=$(git rev-parse HEAD)
            echo "$CURRENT_COMMIT" > /root/Telegrambot/.last_deploy_commit
            echo "üíæ –°–æ—Ö—Ä–∞–Ω—ë–Ω –∫–æ–º–º–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–ø–ª–æ—è: $CURRENT_COMMIT"
            
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"

