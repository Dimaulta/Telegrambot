name: Deploy to Production (Smart Rebuild)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # –ù—É–∂–Ω–æ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∫–æ–º–º–∏—Ç–æ–º
      
      - name: Detect changed services
        id: changed
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –ø–∞–ø–∫–∏/—Å–µ—Ä–≤–∏—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # –ù–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏)
          NON_WORKING_SERVICES="veonowbot|banananowbot|soranowbot|golosnowbot|AntispamNowBot|NeurVideoBot"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏–ª–∏ —Ç–æ–ª—å–∫–æ services.json
          ONLY_NON_WORKING=$(echo "$CHANGED_FILES" | grep -vE "^($NON_WORKING_SERVICES)/|^config/services.json$|^docs/|^\.github/|^README|^SECURITY|^TRANSFER|^check_ssl|^config/nginx|^config/traefik" || true)
          
          if [ -z "$ONLY_NON_WORKING" ]; then
            # –ò–∑–º–µ–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏–ª–∏ —Ç–æ–ª—å–∫–æ services.json/docs - –Ω–µ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º
            SERVICES="none"
          else
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–∏–µ —Ñ–∞–π–ª—ã (—Ç—Ä–µ–±—É—é—Ç –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –≤—Å–µ—Ö)
            if echo "$CHANGED_FILES" | grep -qE "docker-compose.prod.yml|Dockerfile.prod|Package.swift|Package.resolved"; then
              SERVICES="all"
            else
              # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã
              SERVICES=""
              if echo "$CHANGED_FILES" | grep -qE "^Neurfotobot/|^neurfotobot/"; then
                SERVICES="$SERVICES neurfotobot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^Roundsvideobot/|^roundsvideobot/"; then
                SERVICES="$SERVICES roundsvideobot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^nowmttbot/"; then
                SERVICES="$SERVICES nowmttbot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^gsfortextbot/"; then
                SERVICES="$SERVICES gsfortextbot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^contentfabrikabot/"; then
                SERVICES="$SERVICES contentfabrikabot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^pereskaznowbot/"; then
                SERVICES="$SERVICES pereskaznowbot"
              fi
              if echo "$CHANGED_FILES" | grep -qE "^nowcontrollerbot/"; then
                SERVICES="$SERVICES nowcontrollerbot"
              fi
              
              # –ï—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã - –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≤—Å—ë –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
              if [ -z "$SERVICES" ]; then
                SERVICES="all"
              fi
            fi
          fi
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "üîç –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã: $SERVICES"
      
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_SSH_PORT }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /root/Telegrambot
            echo "üì• –ü–æ–ª—É—á–∞—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ main..."
            git fetch origin
            git checkout main
            git pull origin main
            
            CHANGED_SERVICES="${{ steps.changed.outputs.services }}"
            
            if [ "$CHANGED_SERVICES" = "none" ]; then
              echo "‚ÑπÔ∏è –ò–∑–º–µ–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã/services.json/–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è - –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
            elif [ "$CHANGED_SERVICES" = "all" ]; then
              echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
              docker compose -f docker-compose.prod.yml build
              docker compose -f docker-compose.prod.yml up -d
            else
              echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã: $CHANGED_SERVICES"
              for service in $CHANGED_SERVICES; do
                echo "  ‚Üí –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é $service..."
                docker compose -f docker-compose.prod.yml build $service
                docker compose -f docker-compose.prod.yml up -d $service
              done
            fi
            
            echo "‚è≥ –ñ–¥—É –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (30 —Å–µ–∫—É–Ω–¥)..."
            sleep 30
            
            echo "üîó –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é webhooks..."
            set -a; source config/.env; set +a
            ./config/set-webhooks.sh
            
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose -f docker-compose.prod.yml ps
            
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"

