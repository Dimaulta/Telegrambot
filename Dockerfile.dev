# ================================
# Dockerfile для разработки
# Используется для локальной разработки в Docker контейнере
# ================================
FROM swift:6.0-noble

# Build argument для указания продукта
ARG PRODUCT=App

# Install зависимости для разработки
RUN export DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true \
    && apt-get -q update \
    && apt-get -q dist-upgrade -y \
    && apt-get install -y \
      libjemalloc-dev \
      curl \
      libsqlite3-dev \
      ffmpeg \
      python3 \
      python3-pip \
      wget \
      ca-certificates \
    && pip3 install --no-cache-dir --break-system-packages yt-dlp \
    && wget -qO /usr/local/bin/yt-dlp https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp \
    && chmod a+rx /usr/local/bin/yt-dlp \
    && rm -r /var/lib/apt/lists/*

# Рабочая директория
WORKDIR /app

# Копируем Package.swift для разрешения зависимостей
# Это создаёт кэшированный слой, который пересобирается только при изменении зависимостей
COPY Package.swift Package.resolved* ./

# Разрешаем зависимости (кэшируется если Package.swift не изменился)
RUN swift package resolve

# Код будет монтироваться через volume в docker-compose.dev.yml
# Поэтому не копируем его здесь - это позволяет редактировать код на Mac
# и видеть изменения сразу в контейнере

# По умолчанию запускаем swift run (переопределяется в docker-compose)
CMD ["swift", "run", "NowControllerBot"]

