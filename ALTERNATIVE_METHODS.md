# Альтернативные методы получения видео без ватермарки

## Текущая проблема
- Токен сессии не работает или не тот
- Видео всё ещё с ватермаркой
- UUID без ватермарки находится, но ссылка на видео не найдена

## Альтернативные методы

### 1. Правильный токен сессии
**Как получить:**
1. Открой DevTools (F12) в браузере
2. Перейди на вкладку **Application** (или **Хранилище**)
3. В левом меню выбери **Cookies** → `https://sora.chatgpt.com`
4. Найди куку `__Secure-next-auth.session-token`
5. Скопируй **только значение** (без имени куки)
6. Вставь в `config/.env` как `SORA_SESSION_TOKEN=значение`

**Важно:** 
- Токен должен начинаться с `eyJ` (JWT/JWE формат)
- НЕ должен начинаться с `token=` или `__Secure-next-auth.session-token=`
- Токен истекает через некоторое время, нужно обновлять

### 2. Использование API endpoints
**Пробуем разные endpoints:**
- `https://sora.chatgpt.com/api/share/{shareId}` - может вернуть данные о видео
- `https://sora.chatgpt.com/backend/public/share/{shareId}` - публичный endpoint
- GraphQL API (если есть) - может вернуть данные о видео

**Что нужно:**
- Правильный токен сессии в заголовке `Authorization: Bearer <token>`
- Или токен в куках

### 3. Глубокий поиск в __NEXT_DATA__
**Что сделано:**
- ✅ Добавлен глубокий поиск ссылок на видео в `__NEXT_DATA__`
- ✅ Поиск по всем вложенным объектам
- ✅ Фильтрация ссылок с ватермаркой

**Что проверить:**
- Загружается ли `__NEXT_DATA__` полностью?
- Есть ли в нём ссылки на видео?
- Правильно ли определяется UUID без ватермарки?

### 4. Использование UUID для запроса к API
**Идея:**
Если UUID без ватермарки найден, но ссылка не найдена, можно:
1. Использовать UUID для запроса к API
2. API может вернуть правильную ссылку с токеном

**Endpoint для проверки:**
```
GET https://sora.chatgpt.com/api/videos/{uuid}
Authorization: Bearer <token>
```

### 5. Использование других сервисов
**Альтернативы:**
- ScrapingBee API (если есть ключ)
- ScraperAPI (если есть ключ)
- Другие сервисы для рендеринга JS

### 6. Прямое скачивание через браузер
**Идея:**
Если ссылка найдена, но не работает из-за истёкшего токена:
1. Скачать видео сразу после извлечения ссылки
2. Отправить файл пользователю
3. Не полагаться на временные ссылки

**Реализовано:** ✅ Fallback на скачивание видео уже добавлен

## Рекомендации

### Первым делом:
1. **Проверить токен** - правильно ли он скопирован?
2. **Обновить токен** - может быть, он истёк?
3. **Проверить логи** - что находится в `__NEXT_DATA__`?

### Если токен не работает:
1. Попробовать получить новый токен
2. Проверить, что токен используется правильно (кука vs заголовок)
3. Попробовать использовать токен в заголовке `Authorization: Bearer`

### Если ссылка не найдена:
1. Проверить логи - какие UUID находятся?
2. Проверить, загружается ли `__NEXT_DATA__` полностью?
3. Попробовать использовать UUID для запроса к API

## Команды для проверки

```bash
# Проверить логи после отправки ссылки
docker logs playwright-service --tail 500 | grep -E "UUID|__NEXT_DATA__|ссылка|video"

# Проверить, что возвращает API
docker logs playwright-service --tail 200 | grep -E "API request.*\[200\]|Получен ответ от API"

# Проверить приоритизацию
docker logs playwright-service --tail 200 | grep -E "Приоритизированные|MAIN VIDEO|NOT MAIN VIDEO"
```

