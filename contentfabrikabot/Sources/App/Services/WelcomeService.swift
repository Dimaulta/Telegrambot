import Vapor
import Fluent

/// –°–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
struct WelcomeService {
    
    /// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    static func sendWelcome(
        userId: Int64,
        chatId: Int64,
        token: String,
        req: Request
    ) async throws {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–Ω–∞–ª
        let channel = try await ChannelService.findUserChannel(ownerUserId: userId, db: req.db)
        
        var welcomeMessage = """
–ü—Ä–∏–≤–µ—Ç! –Ø ContentFabrikaBot ‚Äî –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Å—Ç—ã –¥–ª—è —Ç–≤–æ–µ–≥–æ Telegram –∫–∞–Ω–∞–ª–∞ –≤ —Ç–≤–æ—ë–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–º —Å—Ç–∏–ª–µ! üìù

üìå –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:

1Ô∏è‚É£ –î–æ–±–∞–≤—å –º–µ–Ω—è –≤ —Å–≤–æ–π –∫–∞–Ω–∞–ª –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å –ø—Ä–∞–≤–æ–º –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤

2Ô∏è‚É£ –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ—à–ª–∏ –º–Ω–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ 5-10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ—Å—Ç–æ–≤ (Forward –∏–∑ –∫–∞–Ω–∞–ª–∞ –≤ —ç—Ç–æ—Ç —á–∞—Ç)

3Ô∏è‚É£ –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "–ò–∑—É—á–∏—Ç—å –∫–∞–Ω–∞–ª" –Ω–∏–∂–µ ‚Äî —è –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å—Ç–∏–ª—å

4Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ç–µ–º—É –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞ ‚Äî —è —Å–æ–∑–¥–∞–º –µ–≥–æ –≤ —Ç–≤–æ—ë–º —Å—Ç–∏–ª–µ

5Ô∏è‚É£ –ü–æ—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏—è—Ö –∫–∞–Ω–∞–ª–∞ –∏ –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞

üí° –í–∞–∂–Ω–æ: 
‚Ä¢ –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —è —Å—Ç–∞–Ω—É –∞–¥–º–∏–Ω–æ–º, —è –±—É–¥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã
‚Ä¢ –î–ª—è –∏–∑—É—á–µ–Ω–∏—è —Å—Ç–∏–ª—è –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–ª–∞—Ç—å –ø–æ—Å—Ç—ã –∏–∑ –∫–∞–Ω–∞–ª–∞ (Forward), –∞ –Ω–µ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
‚Ä¢ –¢—ã —Å–º–æ–∂–µ—à—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç –≤ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏—è—Ö –¥–æ –º–æ–º–µ–Ω—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
"""
        
        if let channel = channel {
            let channelId = try channel.requireID()
            let postsCount = try await ChannelPost.query(on: req.db)
                .filter(\.$channel.$id == channelId)
                .count()
            
            if postsCount > 0 {
                welcomeMessage += "\n\n‚úÖ –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–π–¥–µ–Ω–æ \(postsCount) –ø–æ—Å—Ç(–æ–≤) –∏–∑ —Ç–≤–æ–µ–≥–æ –∫–∞–Ω–∞–ª–∞."
            } else {
                welcomeMessage += "\n\n‚ö†Ô∏è –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤. –ü–µ—Ä–µ—à–ª–∏ –º–Ω–µ –ø–æ—Å—Ç—ã –∏–∑ –∫–∞–Ω–∞–ª–∞ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è —Å—Ç–∏–ª—è."
            }
        } else {
            welcomeMessage += "\n\n‚ö†Ô∏è –ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –î–æ–±–∞–≤—å –º–µ–Ω—è –≤ —Å–≤–æ–π –∫–∞–Ω–∞–ª –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."
        }

        var buttons: [[InlineKeyboardButton]] = []
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞–Ω–∞–ª –∏ –ø–æ—Å—Ç—ã
        if let channel = try await ChannelService.findUserChannel(ownerUserId: userId, db: req.db) {
            let channelId = try channel.requireID()
            let postsCount = try await ChannelPost.query(on: req.db)
                .filter(\.$channel.$id == channelId)
                .count()
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∏–∑—É—á–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å
            let hasStyleProfile = (try? await StyleProfile.query(on: req.db)
                .filter(\.$channel.$id == channelId)
                .filter(\.$isReady == true)
                .first()) != nil
            
            // –ö–Ω–æ–ø–∫–∞ "–ò–∑—É—á–∏—Ç—å –∫–∞–Ω–∞–ª" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –º–∏–Ω–∏–º—É–º 3 –ø–æ—Å—Ç–∞
            if postsCount >= 3 {
                buttons.append([
                    InlineKeyboardButton(text: "üìö –ò–∑—É—á–∏—Ç—å –∫–∞–Ω–∞–ª", callback_data: "analyze_channel")
                ])
                
                // –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–∏–∑—É—á–∏—Ç—å" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∏–ª—å —É–∂–µ –∏–∑—É—á–µ–Ω
                if hasStyleProfile {
                    buttons.append([
                        InlineKeyboardButton(text: "üîÑ –ü–µ—Ä–µ–∏–∑—É—á–∏—Ç—å —Å—Ç–∏–ª—å", callback_data: "relearn_style")
                    ])
                }
            } else if postsCount > 0 {
                // –ï—Å–ª–∏ –ø–æ—Å—Ç–æ–≤ –º–µ–Ω—å—à–µ 3, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–æ –Ω–µ –∫–Ω–æ–ø–∫—É
                welcomeMessage += "\n\n‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ —Ç–æ–ª—å–∫–æ \(postsCount) –ø–æ—Å—Ç(–∞). –î–ª—è –∏–∑—É—á–µ–Ω–∏—è —Å—Ç–∏–ª—è –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 –ø–æ—Å—Ç–∞. –ü–µ—Ä–µ—à–ª–∏ –µ—â–µ –ø–æ—Å—Ç—ã –∏–∑ –∫–∞–Ω–∞–ª–∞."
            }
        }
        
        // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö
        buttons.append([
            InlineKeyboardButton(text: "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ", callback_data: "reset_all_data")
        ])
        
        let keyboard = InlineKeyboardMarkup(inline_keyboard: buttons)
        
        try await TelegramService.sendMessageWithKeyboard(
            token: token,
            chatId: chatId,
            text: welcomeMessage,
            keyboard: keyboard,
            client: req.client
        )
    }
}

